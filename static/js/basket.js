"use strict";nBASKET.view=function(){nSESSION.init();var v_count=0;var v_to_pay=0;var v_tbody=$('#basket-list tbody').empty();for(var v_i=0;v_i<nUSER.data.basket.length;v_i++){v_count+=nUSER.data.basket[v_i].count;v_to_pay+=nUSER.data.basket[v_i].count*nUSER.data.basket[v_i].rub;var v_tr=$('<tr/>');var v_td_no=$('<td/>',{text:(v_i+1)+'.',Class:'tnum'});var v_td_title=$('<td/>',{Class:'ttxt',html:'<a href="'+nUSER.data.basket[v_i].key+'">'+nUSER.data.basket[v_i].title+'</a>'});var v_td_rub=$('<td/>',{text:nBASKET.dig_split(nUSER.data.basket[v_i].rub),Class:'tprice'});var v_td_count=$('<td/>');v_td_count.append($('<input/>',{type:'number',size:2,value:nUSER.data.basket[v_i].count,min:0,max:9999,step:1,pattern:'\\d+',Class:'tcount'}));var v_td_drop=$('<td/>',{text:"×",Class:'tctrl',data:{no:v_i},title:'Удалить товар'});v_tr.append(v_td_no).append(v_td_title).append(v_td_rub).append(v_td_count).append(v_td_drop);v_tbody.append(v_tr)} $('#buyer-to_pay').text(nBASKET.dig_split(v_to_pay));if(v_to_pay){ $('#buyer-ctrl button').each(function(){ $(this).attr('disabled',false)})}else{ $('#buyer-ctrl button').each(function(){ $(this).attr('disabled',true)})} $(window).resize()};nBASKET.refresh=function(){var v_count;var v_counts=$('#basket-list tbody input[type=number]');var v_basket=[];for(var v_i=0;v_i<nUSER.data.basket.length;v_i++){v_count=$(v_counts[v_i]).val().trim();if(!/^\d+$/.test(v_count)){return}nUSER.data.basket[v_i].count=Number(v_count);if(nUSER.data.basket[v_i].count>0){v_basket.push(nUSER.data.basket[v_i])}}nUSER.data.basket=v_basket;nSESSION.save();nBASKET.view()};nBASKET.dig_split=function(p_digs){return p_digs.toString().replace(/(\d{1,3}(?=(?:\d{3})+(?!\d)))/g,'$1\u00a0')}; $(document).ready(function(){ $('#buyer-time-from').timepicker({timeFormat:'H:mm',interval:15,minTime:'08:00',maxTime:'22:30',defaultTime:'10:00',startTime:'10:00',dynamic:false,dropdown:true,scrollbar:true}); $('#buyer-time-to').timepicker({timeFormat:'H:mm',interval:15,minTime:'08:00',maxTime:'22:30',defaultTime:'20:00',startTime:'20:00',dynamic:false,dropdown:true,scrollbar:true}); $('main table tbody').on('click','td.tctrl',function(){var v_no=Number($(this).data('no'));nUSER.data.basket.splice(v_no,1);nSESSION.save();nBASKET.view()}); $('#buyer-refresh').click(function(){nBASKET.refresh();return false}); $('#buyer-clear').click(function(){nBASKET.clear();nBASKET.view();return false}); $('#buyer-submit').click(function(){var v_name=$('#buyer-name').val().trim();var v_phone=$('#buyer-phone').val().trim();var v_email=$('#buyer-email').val().trim();var v_from=$('#buyer-time-from').val().trim();var v_to=$('#buyer-time-to').val().trim();var v_errors=0; $('#buyer-name').removeClass('error'); $('#buyer-phone').removeClass('error'); $('#buyer-email').removeClass('error');if(nUSER.data.basket.length===0){v_errors++}if(!/^[-А-ЯA-Z. ]+$/i.test(v_name)){ $('#buyer-name').addClass('error');v_errors++}if((v_email==='')&&(v_phone==='')){ $('#buyer-phone').addClass('error'); $('#buyer-email').addClass('error');v_errors++}if(v_email){if(/^[\w]{1}[\w-\.]*@[\w-]+\.[a-z]{2,4}$/i.test(v_email)){}else{ $('#buyer-email').addClass('error');v_errors++}}if(v_phone){if(/^((8|\+7)[\- ]?)?(\(?\d{3}\)?[\- ]?)?[\d\- ]{7,10}$/.test(v_phone)){}else{ $('#buyer-phone').addClass('error');v_errors++}}if(!/^(\d{1,2}):(\d{1,2})$/.test(v_from)){ $('#buyer-time-from').addClass('error');v_errors++}if(!/^(\d{1,2}):(\d{1,2})$/.test(v_to)){ $('#buyer-time-to').addClass('error');v_errors++}if(v_errors){return false}nUSER.data.name=v_name;nUSER.data.phone=v_phone;nUSER.data.email=v_email;nUSER.data.from=v_from;nUSER.data.to=v_to;nUSER.data.rem=$('#buyer-rem').val().trim();nUSER.data.rem=nUSER.data.rem.replace(/</g,'&lt;');nUSER.data.rem=nUSER.data.rem.replace(/>/g,'&gt;'); $('#buyer-order').val(JSON.stringify(nUSER.data));nSESSION.save(); $('#buyer-form').submit()}); $(window).resize(function(){let v_ww=$(window).width();if(v_ww>640){ $('#basket-list').css('width','640px')}else if(v_ww>320){ $('#basket-list').css('width',(v_ww-5)+'px')}else{ $('#basket-list').css('width','auto')}});nBASKET.view(); $('#buyer-phone').val(nUSER.data.phone); $('#buyer-email').val(nUSER.data.email); $('#buyer-name').val(nUSER.data.name)});nBASKET.send=function(p_callback){nAJAX.lock();var v_order={basket:nUSER.basket,email:nUSER.email,phone:nUSER.phone,name:nUSER.name}; $.ajax({type:"POST",url:'/cgi-bin/submit.pl',data:JSON.stringify(v_order),dataType:"json",error:nAJAX.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nAJAX.req_error(p_res);return}nAJAX.unlock();if(typeof p_callback==='function'){p_callback(p_res)}}})};var nAJAX={};nAJAX.lock=function(){};nAJAX.unlock=function(){};nAJAX.req_error=function(p_res){};nAJAX.ajax_error=function(xmlhttp,textStatus,errorThrown){if(xmlhttp.status===404){}else{}};