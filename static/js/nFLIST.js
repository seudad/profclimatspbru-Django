function nFLIST(p_src){this.date_empty='';this.date_undef='????-??-?? ??:??';this.date_format='yyyy.mm.dd HH:MM';this.sort={col:'',asc:false};this.src=(p_src===undefined?'upload':p_src);this._eol_=0}nFLIST.prototype.req_error=function(p_res){console.log('REQ_ERR:',p_res.rc,p_res.msg)};nFLIST.prototype.f_date_time=function(p_datetime){if(p_datetime===undefined){return this.date_undef}if(p_datetime===null){return this.date_empty}if(p_datetime<946670400){return this.date_empty}return(new Date(p_datetime*1000)).format(this.date_format)};nFLIST.prototype.ajax_error=function(xmlhttp,textStatus,errorThrown){console.log('ajax_error:',xmlhttp,textStatus,errorThrown);if(xmlhttp.status===404){}else{}};nFLIST.prototype.get_flist=function(p_find,p_callback){ $.ajax({type:"POST",url:nCFG.ajax.get_path('file-list.pl'),data:{src:this.src,find:this.find},dataType:"json",error:this.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){this.req_error(p_res);return}console.log('nFLIST.get:',p_res);this.data=p_res;if(typeof p_callback==='function'){p_callback(p_res)}}})};nFLIST.prototype.remove=function(p_file_id,p_callback){ $.ajax({type:"POST",url:nCFG.ajax.get_path('file-remove.pl'),data:{src:nFLIST.src,file_id:p_file_id},dataType:"json",error:nFLIST.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nFLIST.req_error(p_res);return}console.log('nFLIST.remove:',p_res);if(typeof p_callback==='function'){p_callback(p_res)}}})};nFLIST.prototype.desc_show=function(p_file_id,p_callback){var v_pos=$('#flist-menu').offset();var v_desc=$('#flist-desc'); $('#flist-desc-id').text(p_file_id);try{ $('#flist-desc-name').text(nFLIST.data.list[p_file_id].FileName); $('#flist-desc-items-fname').val(nFLIST.data.list[p_file_id].FileName); $('#flist-desc-items-title').val(nFLIST.data.list[p_file_id].Title)}catch(e){ $('#flist-desc-name').text(''); $('#flist-desc-items-fname').val(''); $('#flist-desc-items-title').val('')}nFLIST.menu_close();v_desc.css(v_pos).show()};nFLIST.prototype.desc_save=function(p_callback){var v_file_id=$('#flist-desc-id').text().trim();var v_file_name=$('#flist-desc-items-fname').val().trim();var v_title=$('#flist-desc-items-title').val().trim(); $.ajax({type:"POST",url:nCFG.ajax.get_path('file-desc.pl'),data:{src:nFLIST.src,file_id:v_file_id,file_name:v_file_name,file_title:v_title},dataType:"json",error:nFLIST.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nFLIST.req_error(p_res);return}console.log('nFLIST.desc:',p_res);if(typeof p_callback==='function'){p_callback(p_res)}}})};nFLIST.prototype.desc_close=function(){ $('#flist-desc').hide().css({top:-250,left:-250}); $('#flist-desc-id').text('')};nFLIST.prototype.order_by=function(p_ref,p_data){console.log('nFLIST.order_by.10:',p_ref); $('#file-list thead th').removeClass('sorted_asc').removeClass('sorted_desc');var v_col_name=p_ref.attr('id');if(v_col_name===this.sort.col){if(this.sort.asc){this.sort.asc=false}else{this.sort.asc=true}}else{this.sort.col=v_col_name;this.sort.asc=true}var v_data;switch(this.sort.col){case'file-list-id':v_data=this.order_by_id(p_data);break;case'file-list-name':v_data=this.order_by_name(p_data);break;case'file-list-type':v_data=this.order_by_type(p_data);break;case'file-list-uploaded':v_data=this.order_by_uploaded(p_data);break;case'file-list-upload-uid':v_data=this.order_by_uploaded(p_data);break;case'file-list-upload-datetime':v_data=this.order_by_uploaded_datetime(p_data);break;case'file-list-title':v_data=this.order_by_title(p_data);break;default:v_data=p_data}if(this.sort.asc){p_ref.addClass('sorted_asc')}else{p_ref.addClass('sorted_desc');v_data.order=v_data.order.reverse()}return v_data};nFLIST.prototype.order_by_id=function(p_data){p_data.order=p_data.order.sort(function(a,b){if(a>b)return 1;if(a<b)return-1;return 0});return p_data};nFLIST.prototype.order_by_name=function(p_data){p_data.order=p_data.order.sort(function(a,b){var v_a=p_data.list[a]===null?'':p_data.list[a].FileName;var v_b=p_data.list[b]===null?'':p_data.list[b].FileName;if(v_a>v_b)return 1;if(v_a<v_b)return-1;return 0});return p_data};nFLIST.prototype.order_by_type=function(p_data){p_data.order=p_data.order.sort(function(a,b){var v_a=p_data.list[a]===null?'':p_data.list[a].ContentType;var v_b=p_data.list[b]===null?'':p_data.list[b].ContentType;if(v_a>v_b)return 1;if(v_a<v_b)return-1;return 0});return p_data};nFLIST.prototype.order_by_uploaded=function(p_data){p_data.order=p_data.order.sort(function(a,b){var v_a=p_data.list[a]===null?'':p_data.list[a].UserId+' '+a;var v_b=p_data.list[b]===null?'':p_data.list[b].UserId+' '+b;if(v_a>v_b)return 1;if(v_a<v_b)return-1;return 0});return p_data};nFLIST.prototype.order_by_uploaded_datetime=function(p_data){p_data.order=p_data.order.sort(function(a,b){var v_a=p_data.list[a]===null?'':a+p_data.list[a].UserId;var v_b=p_data.list[b]===null?'':b+p_data.list[b].UserId;if(v_a>v_b)return 1;if(v_a<v_b)return-1;return 0});return p_data};nFLIST.prototype.order_by_title=function(p_data){p_data.order=p_data.order.sort(function(a,b){var v_a=p_data.list[a]===null?'':p_data.list[a].Title;var v_b=p_data.list[b]===null?'':p_data.list[b].Title;if(v_a>v_b)return 1;if(v_a<v_b)return-1;return 0});return p_data};nFLIST.prototype.load=function(p_file_id){ $('#file_id').val(p_file_id); $('#frmLoad').submit()};nFLIST.prototype.refresh=function(p_callback){this.get_flist({},function(p_res){this.list=p_res.list;this.order=[];for(var v_k in this.list){this.order.push(v_k)}console.log('nFLIST.data:',this.list);if(typeof p_callback==='function'){p_callback(this)}})};nFLIST.prototype.menu_close=function(){ $('#flist-menu').hide().css({top:-250,left:-250}); $('#flist-menu-id').text('')};