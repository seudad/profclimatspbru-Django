"use strict";var nBASKET={data:{list:[],count:0},flags:{opened:false}};nBASKET.reset=function(){nBASKET.data.list=[];nBASKET.data.count=0};nBASKET.sum=function(){var v_sum=0;for(var v_i=0;v_i<nBASKET.data.list.length;v_i++){v_sum+=Number(nBASKET.data.list[v_i].price_rub)*nBASKET.data.list[v_i].count}return v_sum.toFixed(2)*1};nBASKET.info=function(){if(nBASKET.data.count===0){ $('#basket-info').text('Пусто')}else{ $('#basket-info').text(nBASKET.data.count+' на '+nBASKET.sum().toFixed(0))}};nBASKET.add=function(p_item){nBASKET.refresh();for(var v_i=0;v_i<nBASKET.data.list.length;v_i++){if(nBASKET.data.list[v_i].manufacturer+' '+nBASKET.data.list[v_i].utype+' '+nBASKET.data.list[v_i].btype+' '+nBASKET.data.list[v_i].model===p_item.manufacturer+' '+p_item.utype+' '+p_item.btype+' '+p_item.model){nBASKET.data.count++;nBASKET.data.list[v_i].count++;nBASKET.info();nBASKET.update();return}}nBASKET.data.list.push({manufacturer:p_item.manufacturer,utype:p_item.utype,btype:p_item.btype,model:p_item.model,price_rub:p_item.rub,price_usd:p_item.usd,count:1});nBASKET.data.count++;nBASKET.info();nBASKET.update()};nBASKET.delete=function(p_item_no){nBASKET.data.count-=nBASKET.data.list[p_item_no].count;nBASKET.data.list.splice(p_item_no,1);nBASKET.info();nBASKET.update()};nBASKET.clear=function(){nBASKET.data.list=[];nBASKET.data.count=0;nBASKET.info();nBASKET.update()};nBASKET.refresh=function(){var v_cprof=$.jStorage.get('nCPROF');if((v_cprof!==null)&&(typeof v_cprof==='object')&&(v_cprof.uid!==undefined)){if(typeof(v_cprof.basket)==='object'){nBASKET.data=v_cprof.basket}}};nBASKET.update=function(){nSESSION.usr.basket=nBASKET.data; $.jStorage.set('nCPROF',nSESSION.usr,{TTL:parseInt(nSESSION.usr.expire,10)*1000});if(!nBASKET.flags.opened){return}var v_tbody=$('#basket-list tbody').empty();var v_sum=0;for(var v_i=0;v_i<nBASKET.data.list.length;v_i++){var v_price=Number(nBASKET.data.list[v_i].price_rub);v_tbody.append('<tr><td>'+nBASKET.data.list[v_i].manufacturer+' '+nBASKET.data.list[v_i].utype+' '+nBASKET.data.list[v_i].btype+' '+nBASKET.data.list[v_i].model+'</td><td class="num"><input type="number" min="1" max="5000" value="'+nBASKET.data.list[v_i].count+'" step="1" class="number" data-seqno="'+v_i+'"></td><td class="num">'+v_price+'</td><td class="num">'+(v_price*nBASKET.data.list[v_i].count).toFixed(0)+'</td><td class="cmd"><span class="row-cmd typcn typcn-times" data-seqno="'+v_i+'"></span></td>');v_sum+=v_price*nBASKET.data.list[v_i].count} $('#basket-summary').text('Итого на '+v_sum.toFixed(0)+' руб.')};nBASKET.show=function(){ $('#basket-win').css({top:'60pt',right:'4pt'});nBASKET.flags.opened=true;nBASKET.update(); $('#basket-win').show()};nBASKET.hide=function(){ $('#basket-win').hide();nBASKET.flags.opened=false};nBASKET.buy={};nBASKET.buy.show=function(){ $('#basket-buy-win').css({top:'60pt',right:'4pt'}); $('#basket-buy-win').show()};nBASKET.buy.accept=function(){var v_errors=0; $("#basket-buy-customer td").removeClass('error-param');if(!is_userid(nSESSION.usr.uid)){v_errors++; $("#basket-buy-userid").addClass('error-param')}if(!is_rus_name(nSESSION.usr.surname)){v_errors++; $("#basket-buy-surname").addClass('error-param')}if(!is_rus_name(nSESSION.usr.name)){v_errors++; $("#basket-buy-name").addClass('error-param')}if(!is_phone(nSESSION.usr.phone)){v_errors++; $("#basket-buy-phone").addClass('error-param')}if(!is_email(nSESSION.usr.email)){v_errors++; $("#basket-buy-email").addClass('error-param')}if(is_empty(nSESSION.usr.address)){v_errors++; $("#basket-buy-address").addClass('error-param')}if(v_errors){return}var v_comment=$("#basket-buy-comment").val().trim();var v_order={uid:nSESSION.usr.uid,sum_usd:0,sum_rub:0,course:Number($('#d1r').val()),list:[],comment:v_comment,datetime:(new Date().getTime())};for(var v_i=0;v_i<nBASKET.data.list.length;v_i++){var v_item=nBASKET.data.list[v_i];v_order.list.push({manufacturer:v_item.manufacturer,utype:v_item.utype,btype:v_item.btype,model:v_item.model,count:v_item.count,price_usd:v_item.price_usd,price_rub:v_item.price_rub});v_order.sum_usd+=v_item.price_usd;v_order.sum_rub+=v_item.price_rub}var v_param={uid:nSESSION.uid,sid:nSESSION.sid,cid:nSESSION.uid,order:JSON.stringify(v_order)}; $.ajax({type:"POST",url:nCFG.ajax.get_path('nORDERS.add.pl'),data:v_param,dataType:"json",error:nAJAX.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){return}nBASKET.reset();nBASKET.info();nBASKET.update(); $('#basket-buy-win').hide()}})};nBASKET.buy.close=function(){ $('#basket-buy-win').hide()};nBASKET.init=function(){ $('#basket').click(function(){if(nBASKET.flags.opened){nBASKET.hide()}else{if(nBASKET.data.count>0){nBASKET.show()}}}); $('#basket-buy').click(function(){if(!nSESSION.authorized()){nSESSION.login.show();return} $('#basket-buy-msg').empty();nBASKET.hide(); $("#basket-buy-userid").text(nSESSION.usr.uid); $("#basket-buy-surname").text(nSESSION.usr.surname); $("#basket-buy-name").text(nSESSION.usr.name); $("#basket-buy-patronymic").text(nSESSION.usr.patronymic); $("#basket-buy-phone").text(nSESSION.usr.phone); $("#basket-buy-email").text(nSESSION.usr.email); $("#basket-buy-address").text(nSESSION.usr.address); $("#basket-buy-comment").val('');nBASKET.buy.show()}); $('#basket-buy-accept').click(function(){nBASKET.buy.accept()}); $('#basket-buy-back').click(function(){nBASKET.buy.close();nBASKET.show()}); $('#basket-buy-close').click(function(){nBASKET.buy.close()}); $('#basket-clear').click(function(){nBASKET.clear()}); $('#basket-close').click(function(){nBASKET.hide()}); $('#basket-list tbody').on('click','.row-cmd',function(){nBASKET.delete($(this).data('seqno'))}); $('#basket-list tbody').on('change','input',function(){nBASKET.data.list[$(this).data('seqno')].count=parseInt($(this).val(),10);var v_count=0;for(var v_i in nBASKET.data.list){v_count+=nBASKET.data.list[v_i].count}nBASKET.data.count=v_count;nBASKET.update();nBASKET.info()})};