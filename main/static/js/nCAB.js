var nCAB={pfx:'',usr:{},_state:{0:"в обработке",1:"выполняется",2:"выполнен",3:"отменен"},menu:{form:{}},orders:{form:{},sort:{desc:true,col:'no'}},card:{form:{}}};nCAB.state_decode=function(p_state){if(p_state===undefined){return'-нет данных-'}var v_state=nCAB._state[p_state];return(v_state===undefined?'-ошибка-':v_state)};nCAB.init=function(p_pfx){if(p_pfx===undefined){p_pfx='cab'}nCAB.pfx=p_pfx;nCAB.menu.form.win=$('#'+p_pfx+'-menu-win');nCAB.menu.form.title=$('#'+p_pfx+'-menu-win-title');nCAB.menu.form.body=$('#'+p_pfx+'-menu-win-body');nCAB.menu.form.body=$('#'+p_pfx+'-menu-list');nCAB.menu.form.ctrl=$('#'+p_pfx+'-menu-win-ctrl');nCAB.menu.form.close=$('#'+p_pfx+'-menu-close');nCAB.menu.form.card=$('#'+p_pfx+'-menu-card');nCAB.menu.form.orders=$('#'+p_pfx+'-menu-orders');nCAB.menu.close=function(){};nCAB.menu.form.close.click(function(){nCAB.menu_hide()});nCAB.menu.form.card.click(function(){nCAB.menu_hide();nCAB.card_show()});nCAB.menu.form.orders.click(function(){nCAB.menu_hide();nCAB.orders_show()});nCAB.card.form.win=$('#'+p_pfx+'-card-win');nCAB.card.form.title=$('#'+p_pfx+'-card-win-title');nCAB.card.form.uid=$('#'+p_pfx+'-card-uid');nCAB.card.form.pass0=$('#'+p_pfx+'-card-pass0');nCAB.card.form.pass1=$('#'+p_pfx+'-card-pass1');nCAB.card.form.pass2=$('#'+p_pfx+'-card-pass2');nCAB.card.form.name=$('#'+p_pfx+'-card-name');nCAB.card.form.patronymic=$('#'+p_pfx+'-card-patronymic');nCAB.card.form.surname=$('#'+p_pfx+'-card-surname');nCAB.card.form.email=$('#'+p_pfx+'-card-email');nCAB.card.form.address=$('#'+p_pfx+'-card-address');nCAB.card.form.phone=$('#'+p_pfx+'-card-phone');nCAB.card.form.save=$('#'+p_pfx+'-card-save');nCAB.card.form.close=$('#'+p_pfx+'-card-close');nCAB.card.form.menu=$('#'+p_pfx+'-card-menu');nCAB.card.save=function(){};nCAB.card.close=function(){};nCAB.card.form.save.click(function(){ $('#'+p_pfx+'-card-table tbody tr').removeClass('error-param');var v_param={uid:nCAB.usr.uid,sid:nCAB.usr.sid,name:nCAB.card.form.name.val(),patronymic:nCAB.card.form.patronymic.val(),surname:nCAB.card.form.surname.val(),email:nCAB.card.form.email.val(),address:nCAB.card.form.address.val(),phone:nCAB.card.form.phone.val()};if(!/^[-_a-z0-9]{1,20}$/i.test(v_param.uid)){nCAB.card.form.uid.addClass('error-param');return}var v_pass0=nCAB.card.form.pass0.val().trim();var v_pass1=nCAB.card.form.pass1.val().trim();var v_pass2=nCAB.card.form.pass2.val().trim();if((v_pass0!=='')||(v_pass0!=='')||(v_pass0!=='')){var v_pass_err=0;if(!/^[-_.~а-яА-ЯёЁa-zA-Z0-9]{5,}$/i.test(v_pass0)){nCAB.card.form.pass0.addClass('error-param');v_pass_err++}if(/^[-_.~а-яА-ЯёЁa-zA-Z0-9]{5,}$/i.test(v_pass1)){nCAB.card.form.pass1.addClass('error-param');v_pass_err++}else{if(v_pass1!==v_pass2){nCAB.card.form.pass1.addClass('error-param');nCAB.card.form.pass2.addClass('error-param');v_pass_err++}}if(v_pass_err>0){return}v_param.hash0=CryptoJS.MD5(v_pass0+'~'+v_param.uid).toString();if(v_pass1.length>0){v_param.hash1=CryptoJS.MD5(v_pass1+'~'+v_param.uid).toString()}} $.ajax({type:"POST",url:nCFG.ajax.get_path('nUSR.update.pl'),data:v_param,dataType:"json",error:nCAB.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nCAB.req_error(p_res);return}nCAB.usr=p_res.usr;if(typeof nCAB.card.save==='function'){nCAB.card.save(p_res)}}})});nCAB.card.form.close.click(function(){nCAB.card_hide()});nCAB.card.form.menu.click(function(){nCAB.card_hide();nCAB.menu_show()});nCAB.orders.form.win=$('#'+p_pfx+'-orders-win');nCAB.orders.form.title=$('#'+p_pfx+'-orders-win-title');nCAB.orders.form.body=$('#'+p_pfx+'-orders-win-body');nCAB.orders.form.orders=$('#'+p_pfx+'-orders');nCAB.orders.form.order=$('#'+p_pfx+'-order');nCAB.orders.form.ctrl=$('#'+p_pfx+'-orders-win-ctrl');nCAB.orders.form.prev=$('#'+p_pfx+'-orders-prev');nCAB.orders.form.next=$('#'+p_pfx+'-orders-next');nCAB.orders.form.list=$('#'+p_pfx+'-orders-list');nCAB.orders.form.close=$('#'+p_pfx+'-orders-close');nCAB.orders.form.menu=$('#'+p_pfx+'-orders-menu');nCAB.orders.close=function(){};nCAB.orders.list=function(p_res){var v_head=$('#'+p_pfx+'-orders-list-table-head th');var v_body=$('#'+p_pfx+'-orders-list-table-body').empty();for(var v_i=0;v_i<p_res.numbers.length;v_i++){var v_no=p_res.numbers[v_i];var v_tr=$('<tr/>',{data:{no:v_no}});v_tr.append($('<td/>',{Class:'num',text:v_i+1,css:{width: $(v_head.get(0)).width()}}));v_tr.append($('<td/>',{Class:'num',text:v_no,css:{width: $(v_head.get(1)).width()}}));v_tr.append($('<td/>',{Class:'date',text:(new Date(p_res.list[v_no].datetime)).format('yyyy-mm-dd HH:MM'),css:{width: $(v_head.get(2)).width()}}));v_tr.append($('<td/>',{Class:'date',text:nCAB.state_decode(p_res.list[v_no].state),css:{width: $(v_head.get(3)).width()}}));v_tr.append($('<td/>',{Class:'num',text:p_res.list[v_no].sum_rub,css:{width: $(v_head.get(4)).width()}}));v_body.append(v_tr)}nCAB.orders.form.win.show()};nCAB.orders.form.close.click(function(){nCAB.orders_hide()});nCAB.orders.form.menu.click(function(){nCAB.orders_hide();nCAB.menu_show()});nCAB.orders.form.list.click(function(){nCAB.order_hide();nCAB.menu_hide();nCAB.orders_show()}); $('#'+p_pfx+'-orders-list-table-head').on('click','th.sortable',function(){var v_th=$(this);var v_col=$(this).data('col');if(nCAB.orders.sort.col===v_col){nCAB.orders.sort.desc=!nCAB.orders.sort.desc}else{nCAB.orders.sort.col=v_col;nCAB.orders.sort.desc=true}nCAB.orders_list(nCAB.orders.list)}); $('#'+p_pfx+'-orders-list-table-body').on('click','tr',function(){var v_tr=$(this);nCAB.order_show(v_tr.data('no'))})};nCAB.req_error=function(p_res){};nCAB.ajax_error=function(xmlhttp,textStatus,errorThrown){if(xmlhttp.status===404){}else{}};nCAB.card_show=function(){nCAB.card.form.win.show()};nCAB.card_hide=function(){nCAB.card.form.win.hide()};nCAB.card_set_save=function(p_function){nCAB.card.save=p_function};nCAB.card_set_close=function(p_function){nCAB.card.close=p_function};nCAB.user_set_values=function(p_usr){nCAB.usr=p_usr;nCAB.card.form.uid.val(p_usr.uid);nCAB.card.form.pass0.val(p_usr.pass0);nCAB.card.form.pass1.val(p_usr.pass1);nCAB.card.form.pass2.val(p_usr.pass2);nCAB.card.form.surname.val(p_usr.surname);nCAB.card.form.name.val(p_usr.name);nCAB.card.form.patronymic.val(p_usr.patronymic);nCAB.card.form.email.val(p_usr.email);nCAB.card.form.address.val(p_usr.address);nCAB.card.form.phone.val(p_usr.phone)};nCAB.orders_show=function(){nCAB.orders.form.orders.show();nCAB.orders.form.order.hide();nCAB.orders_list(nCAB.orders.list)};nCAB.orders_hide=function(){nCAB.orders.form.win.hide()};nCAB.order_get=function(p_no,p_callback){var v_param={uid:nCAB.usr.uid,sid:nCAB.usr.sid,cid:nCAB.usr.uid,no:p_no}; $.ajax({type:"POST",url:nCFG.ajax.get_path('nORDERS.get.pl'),data:v_param,dataType:"json",error:nCAB.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nCAB.req_error(p_res);return}if(typeof p_callback==='function'){p_callback(p_res)}}})};nCAB.order_show=function(p_no){nCAB.order_get(p_no,function(p_res){var v_tbody=$('#cab-orders-order-table tbody').empty();var v_order=p_res.order;var v_usr=nCAB.usr; $('#cab-order-no').text(p_no); $('#cab-order-datetime').text(new Date(v_order.datetime).format('yyyy-mm-dd HH:MM')); $('#cab-order-sum').text(v_order.sum_rub);for(var v_i=0;v_i<v_order.list.length;v_i++){var v_item=v_order.list[v_i];v_tbody.append('<tr><td>'+(v_i+1)+'</td><td>'+v_item.manufacturer+' '+v_item.utype+' '+v_item.btype+' '+v_item.model+'</td><td class="num">'+v_item.count+'</td><td class="num">'+v_item.price_rub+'</td><td class="num">'+(v_item.price_rub*v_item.count).toFixed(0)+'</td>')}nCAB.orders.form.orders.hide();nCAB.orders.form.order.show();return})};nCAB.order_hide=function(){nCAB.orders.form.order.hide()};nCAB.orders_list=function(p_orders_list){var v_param={uid:nCAB.usr.uid,sid:nCAB.usr.sid,cid:nCAB.usr.uid}; $.ajax({type:"POST",url:nCFG.ajax.get_path('nORDERS.list.pl'),data:v_param,dataType:"json",error:nCAB.ajax_error,success:function(p_res){if(parseInt(p_res.rc,10)!==0){nCAB.req_error(p_res);return}if(typeof p_orders_list==='function'){p_orders_list(nCAB.orders_sort(p_res))}}})};nCAB.orders_sort=function(p_res){p_res.numbers=[];for(var v_no in p_res.list){p_res.numbers.push(v_no*1)}if(nCAB.orders.sort.col==='no'){p_res.numbers=p_res.numbers.sort(function(a,b){if(a<b){return-1}if(a>b){return 1}return 0})}if(nCAB.orders.sort.col==='sum'){p_res.numbers=p_res.numbers.sort(function(a,b){if(p_res.list[a].sum_rub<p_res.list[b].sum_rub){return-1}if(p_res.list[a].sum_rub>p_res.list[b].sum_rub){return 1}return 0})}if(nCAB.orders.sort.col==='state'){p_res.numbers=p_res.numbers.sort(function(a,b){if(p_res.list[a].state<p_res.list[b].state){return-1}if(p_res.list[a].state>p_res.list[b].state){return 1}return 0})}if(nCAB.orders.sort.col==='datetime'){p_res.numbers=p_res.numbers.sort(function(a,b){if(p_res.list[a].datetime<p_res.list[b].datetime){return-1}if(p_res.list[a].datetime>p_res.list[b].datetime){return 1}return 0})}if(nCAB.orders.sort.desc){p_res.numbers=p_res.numbers.reverse()}return p_res};nCAB.menu_show=function(){nCAB.menu.form.win.show()};nCAB.menu_hide=function(){nCAB.menu.form.win.hide()};